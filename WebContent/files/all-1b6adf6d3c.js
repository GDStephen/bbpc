function BBWeb_Global(){this.refreshCount=0,this.groupChatNotice=!0,this.chatNotice=!0,this.BOSH_SERVICE="https://web.bangcommunity.com/http-bind/",this.TFS_URL="https://web.bangcommunity.com/tfs/",this.jid="",this.loginName="",this.loginAvatar="",this.tojid="",this.pwd="",this.token="",this.username="",this.iniNonFriendFlag=!1,this.keyDownF5=!1,this.initDataFlag=!1,this.circleDataFlag=!1,this.contactDataFlag=!1,this.chatlistDataFlag=!1,this.chatcontactFlag=!1,this.chatcircleFlag=!1,this.userLoading=!0,this.userLoadingjid="",this.jsonArray="",this.ajaxCount=0,this.isChrome=!1,this.array=new Array}function Map(){this.keys=new Array,this.data=new Object,this.put=function(e,t){null==this.data[e]&&this.keys.push(e),this.data[e]=t},this.get=function(e){return this.data[e]},this.remove=function(e){this.data[e]=null,this.keys.remove(e)},this.each=function(e){if("function"==typeof e)for(var t=this.keys.length,a=0;a<t;a++){var n=this.keys[a];e(n,this.data[n],a)}},this.entrys=function(){for(var e=this.keys.length,t=new Array(e),a=0;a<e;a++)t[a]={key:this.keys[a],value:this.data[a]};return t},this.isEmpty=function(){return 0==this.keys.length},this.size=function(){return this.keys.length},this.toString=function(){for(var e="{",t=0;t<this.keys.length;t++,e+=","){var a=this.keys[t];e+=a+"="+this.data[a]}return e+="}"}}function testMap(){var e=new Map;e.put("key1","Comtop"),e.put("key2","南方电网"),e.put("key3","景新花园"),alert("init:"+e),e.put("key1","康拓普"),alert("set key1:"+e),e.remove("key2"),alert("remove key2: "+e);var t="";e.each(function(e,a,n){t+=n+":"+e+"="+a+"/n"}),alert(t)}var BBUI=function(){function e(e,t){document.cookie=e+"="+t}var t=function(){for(var e=new Array,t=0;t<windowsArray.length;t++){var a=chatMap.get(windowsArray[t]);e[t]=a}var n=document.body,r=angular.element(n).scope();r.makeSure1(e)},a=function(){for(var e=new Array,t=0;t<windowsArray.length;t++){var a=chatMap.get(windowsArray[t]);e[t]=a}var n=document.body,r=angular.element(n).scope();r.refresh(e)},n=function(e,t){var a=document.body,n=angular.element(a).scope();n.sendUIMessage(e,t)},r=function(e){var t=chatLogMap.get(e),a=document.body,n=angular.element(a).scope();if("object"==typeof t){for(var r=0;r<t.data.length;r++)n.messageInfo.push(t.data[r]);n.hasContent=!1}else n.hasContent=!0;var o=chatMap.get(e);o.count=0,BBWeb.unReadCount()},o=function(e){var t=new Array,a=circleRoomMap.get(e);if(void 0!=a){var n=a.member;if(null==circleRoomMap.get(e)||void 0==circleRoomMap.get(e))t[0]={};else{t[0]={};for(var r=0;r<n.length;r++){var o={};o.jid=n[r].jid;var i=circleMap.get(n[r].jid);void 0!=i&&(o.displayName=i.displayName),o.nickname=n[r].nickname,o.create=n[r].create,o.role=n[r].role;var l=circleMap.get(o.jid);o.avatar=l.avatar,o.accountType=l.accountType,o.userInfoJson=l,"owner"==o.role?t[0]=o:t[t.length]=o}}}else t=[];return t},i=function(){var e=new Array,t={};t.type="header";var a=document.getElementById("logo").innerHTML;null!=a&&"BangBangCommunity"==a?t.name="Group Chats":null!=a&&"邦邦社区"==a&&(t.name="群聊"),e[e.length]=t;for(var n=new Map,r=new Array,o=0;o<circleRoomMap.size();o++){var i=circleRoomMap.data[circleRoomMap.keys[o]];n.put(i.name_sort+i.jid,i)}r=n.keys.sort();for(var l=0;l<r.length;l++)e[e.length]=n.get(r[l]);n=new Map,r=new Array;for(var s=0;s<contactMap.size();s++){var i=contactMap.data[contactMap.keys[s]];n.put(i.name_sort+i.jid,i)}r=n.keys.sort();for(var c="",g=0;g<r.length;g++)if(c==r[g].substr(0,1))e[e.length]=n.get(r[g]);else{c=r[g].substr(0,1);var t={};t.type="header",t.name=c,e[e.length]=t,e[e.length]=n.get(r[g])}var m=document.body,u=angular.element(m).scope();u.showAllContact(e)},l=function(e){var t=pinyin.getFullChars(e).toUpperCase(),a=new RegExp("[\\u4E00-\\u9FFF]+","g"),n=!0;a.test(e)&&(n=!1);var r=new Array,o={};o.type="header";var i=document.getElementById("logo").innerHTML;null!=i&&"BangBangCommunity"==i?o.name="Contacts":null!=i&&"邦邦社区"==i&&(o.name="好友"),r[r.length]=o;for(var l=0;l<contactMap.size();l++){var s=contactMap.data[contactMap.keys[l]];s.name_sort.indexOf(t)>-1&&(n||s.displayName.indexOf(e)>-1)&&(r[r.length]=s)}1==r.length&&(r=[]);var c={};c.type="header",null!=i&&"BangBangCommunity"==i?c.name="Group Chats":null!=i&&"邦邦社区"==i&&(c.name="群聊"),r[r.length]=c;for(var g=0;g<circleRoomMap.size();g++){var m=circleRoomMap.data[circleRoomMap.keys[g]];m.name_sort.indexOf(t)>-1&&(n||s.name.indexOf(e)>-1)&&(r[r.length]=m)}return 1==r.length&&(r=[]),console.log(r),r},s=function(e,t,a){var n=document.body,r=angular.element(n).scope();r.titleId==e&&r.$apply(function(){for(var e=r.messageInfo.length-1,n=e;n>0;n--)if(r.messageInfo[n].uuid==t){r.messageInfo[n].ackflag=a;break}})},c=function(){var e=document.body,t=angular.element(e).scope();t.choseOnline=!0,t.choseOutline=!1,t.isLoadingOnline=!1},g=function(){var e=document.body,t=angular.element(e).scope();t.choseOnline=!1,t.choseOutline=!0,t.$apply()},m=function(e){var t=0,a=BBUI.myBrowser();if("IE"==a){if(t=e.keyCode,13==t&&0==e.ctrlKey){if(""==$.trim(document.getElementById("editArea").innerHTML)||""==document.getElementById("editArea").innerHTML||"<br>"==document.getElementById("editArea").innerHTML)return e.preventDefault(),e.returnValue=!1,!1;BBUI.dealSendInput(document.getElementById("editArea").innerHTML),"block"==document.getElementById("at_someone").style.display&&(document.getElementById("at_someone").style.display="none");var n=document.body,r=angular.element(n).scope();return r.chatAtMember=r.chatMember,r.$apply(),BBWeb.sendText(),e.preventDefault(),e.returnValue=!1,!1}13==t&&e.ctrlKey&&BBUI.insertBlank()}else{if(t=e.which,13==t&&!e.ctrlKey){if(""==$.trim(document.getElementById("editArea").innerHTML)||""==document.getElementById("editArea").innerHTML)return e.returnValue=!1,!1;BBUI.dealSendInput(document.getElementById("editArea").innerHTML),"block"==document.getElementById("at_someone").style.display&&(document.getElementById("at_someone").style.display="none");var n=document.body,r=angular.element(n).scope();return r.chatAtMember=r.chatMember,r.$apply(),BBWeb.sendText(),e.returnValue=!1,!1}13==t&&e.ctrlKey&&BBUI.insertBlank()}},u=function(){var e=document.getElementById("titleType").value;if("chat"!=e){document.getElementById("at_someone").style.display="block";var t=BBUI.insertInput();document.getElementById("atOneId").value=t;var a=document.getElementById(t);a.focus();var n=a.value;n=$.trim(n),"@"!=n.substr(0,1)&&(document.getElementById(t).value="@"+n),document.getElementById("at_someone").style.left=a.offsetLeft+"px",document.getElementById("at_someone").style.bottom=144-a.offsetTop+36+"px"}},d=function(e){console.log(e);var t,a=document.getElementById("atOneId").value,n=document.getElementById(a).value;e.size=n.length+2,console.log(e.size),console.log(n),n=$.trim(n),"@"!=n.substr(0,1)&&(document.getElementById(a).value="@"+n),t=""==n?"":n.replace("@",""),console.log(t);var r=document.body,o=angular.element(r).scope();o.searchSomeone(t,a),o.$apply()},y=function(e){var t=document.getElementById("editArea"),a=BBUI.getPosition(t);console.log(a.x),console.log(e.clientX),document.getElementById("at_someone").style.left=e.clientX-a.x+"px"},h=function(e){var t="((?:\\/[\\w\\.\\-]+)+)",a=new RegExp(t,["g"]),n=e.match(a);if(null==n)return e;n.sort();for(var r,o,i=[this[0]],l=1;l<n.length+1;l++){var s=BBUI.myBrowser();"IE"==s?(i.push(n[l-1]),o=BBExpression.getExName(n[l-1].split("/")[1]),r='<img width="24" height="24" src="face'+n[l-1]+'">'):"FF"==s?(i.push(n[l-1]),o=BBExpression.getExName(n[l-1].split("/")[1]),r='<img src="face'+n[l-1]+'" height="24px" width="24px">'):n[l-1]!==i[i.length-1]&&(i.push(n[l-1]),o=BBExpression.getExName(n[l-1].split("/")[1]),r=new RegExp('<img src="face'+n[l-1]+'" width="24px" height="24px">',["g"])),e=e.replace(r,o)}return e},B=function(e){console.log(e);var t='id="([^"]*)"',a=new RegExp(t,["g"]),n=e.match(a);if(null==n)return e;for(var r=0;r<n.length;r++){n[r]=n[r].substring(4,n[r].length-1);var o,i=inputsMap.get(n[r]),l=BBUI.myBrowser();if(o="IE"==l?new RegExp('(<input name="'+n[r]+'").*?([^>]*>)',["g"]):new RegExp('(<input id="'+n[r]+'").*?([^>]*>)',["g"]),console.log(o),void 0==i){var s=document.getElementById(n[r]).value;e=e.replace(o,s)}else{var c,g=BBUI.cal(i);c=0==g?2*g+(i.length-g)+1:2*g+(i.length-g)<4?3:2*g+(i.length-g),e=e.replace(o,"<input id='"+n[r]+"' value='"+i+"' style='border: 0;font-style:italic;font-weight: 600;height: 20px;background-color: #f8f8f8;' name='"+n[r]+"'size="+c+" readonly=''>"),console.log(e)}}document.getElementById("editArea").innerHTML=e},f=function(e){var t='id="([^"]*)"',a=new RegExp(t,["g"]),n=e.match(a);if(null==n)return e;for(var r=0;r<n.length;r++){n[r]=n[r].substring(4,n[r].length-1);var o=inputsMap.get(n[r]),i=new RegExp('(<input).*?(id="'+n[r]+'").*?([^>]*>)',["g"]);if(void 0==o){var l=document.getElementById(n[r]).value;e=e.replace(i,l)}else e=e.replace(i,o)}document.getElementById("editArea").innerHTML=e},v=function(e){var t='id="([^"]*)"',a=new RegExp(t,["g"]),n=e.match(a);if(null==n)return e;for(var r=0;r<n.length;r++){n[r]=n[r].substring(4,n[r].length-1);var o=inputsMap.get(n[r]);document.getElementById(n[r]).value=o}return e},b=function(e){var t=document.getElementById(e);t.scrollTop=t.scrollHeight},I=function(){$("#msg_end").focus()},T=function(){document.getElementById("editArea").focus();var e,t;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){t=e.getRangeAt(0),console.log(e.getRangeAt(0)),console.log(t);var a=document.createElement("pre"),n=Math.uuid();a.innerHTML='<input id="add_input_'+n+'" style="border: 0;font-style:italic;font-weight: 600;height: 20px;background-color: #f8f8f8;" onkeyup="BBUI.atKeyup(this)" value="" name="add_input_'+n+'">&nbsp;';for(var r,o,i=document.createDocumentFragment();r=a.firstChild;)console.log(a.firstChild),o=i.appendChild(r),console.log(o);t.insertNode(i),console.log(t),o&&(t=t.cloneRange(),t.setStartAfter(o),t.collapse(!0),e.removeAllRanges(),e.addRange(t))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(html);return document.getElementById("editArea").focus(),"add_input_"+n},M=function(){document.getElementById("editArea").focus(),console.log(document.getElementById("editArea").innerHTML);var e,t;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){t=e.getRangeAt(0),console.log(t);var a=document.createElement("pre");a.innerHTML="\r\n",$("#editArea").append("<br/>");for(var n,r,o=document.createDocumentFragment();n=a.firstChild;)console.log(n),r=o.appendChild(n);console.log(r),t.insertNode(o),r&&(t=t.cloneRange(),t.setStartAfter(r),t.collapse(!0),e.removeAllRanges(),e.addRange(t))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(html)},x=function(){var e=navigator.userAgent,t=e.indexOf("Opera")>-1;return t?"Opera":e.indexOf("Firefox")>-1?"FF":e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Safari")>-1?"Safari":e.indexOf("compatible")>-1||e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1?"IE":void 0},w=function(e){return e.indexOf("&nbsp;")>-1&&(e=e.replace(/\&nbsp;/g," ")),e.indexOf("&amp;")>-1&&(e=e.replace(/\&amp;/g,"&")),e.indexOf("&quot;")>-1&&(e=e.replace(/\&quot;/g,'"')),e.indexOf("&lt;")>-1&&(e=e.replace(/\&lt;/g,"<")),e.indexOf("&gt;")>-1&&(e=e.replace(/\&gt;/g,">")),e},A=function(e){var t=/(<img(?:(?!id|>).)*)(id[\=\"\'\s]+)?([^\"\'\s]*)([\"\']?)([^>]*>)/gi,a=e.match(t);if(null!=a)for(var n=0;n<a.length;n++)(a[n].indexOf("face")<=-1||a[n].indexOf("http")>-1)&&(console.log(e.indexOf(a[n])),e=e.replace(a[n],""));e=e.replace(/<\/?(html|body|form)(?=[\s\/>])[^>]*>/gi,""),e=e.replace(/<(!DOCTYPE)(\n|.)*?>/gi,""),e=e.replace(/<(\/?(\?xml(:\w )?|xml|\w :\w )(?=[\s\/>]))[^>]*>/gi,""),e=e.replace(/<head[^>]*>(\n|.)*?<\/head>/gi,""),e=e.replace(/<(script|style|link|title|meta|textarea|option|select|iframe|hr)(\n|.)*?\/>/gi,""),e=e.replace(/<span[^>]*?><\/span>/gi,""),e=e.replace(/<(head|script|style|textarea|button|select|option|iframe)[^>]*>(\n|.)*?<\/\1>/gi,""),e=e.replace(/<\/?(a|table|tr|td|tbody|thead|th|input|iframe|div|pre|p|span|font|code|o:p|br|h1|h2|h3|h4|ul|li|strong|label|section|em|b|!--|i )[^>]*>/gi,"");do len=e.length,e=e.replace(/(<[a-z][^>]*\s)(?:id|name|language|type|class|style|on\w |\w :\w )=(?:"[^"]*"|\w )\s?/gi,"$1");while(len!=e.length);document.getElementById("editArea").innerHTML=e},C=function(e){var t=document.documentElement.clientWidth,a=(document.documentElement.clientHeight,document.getElementById("img_dom"));document.getElementById("img_preview");e=window.event||e;var n,r,o=this,i=e.wheelDelta||40*e.detail;r=o.getAttribute("_zoomsize").split(","),n=parseInt(o.getAttribute("_zoom"))||100,n+=i/12,n>C.min?(o.setAttribute("_zoom",n),o.style.width=r[0]*n/100+"px",o.style.height=r[1]*n/100+"px",parseInt(o.style.width)>parseInt(a.style.width)?a.style.left=(t-parseInt(o.style.width))/2+"px":a.style.left=(t-parseInt(a.style.width))/2+"px",parseInt(o.style.height)>600&&(a.style.top="")):(a.style.left=(t-parseInt(a.style.width))/2+"px",a.style.top="100px")};C.add=function(e,t){C.min=t||50,e.onmousewheel=C,"a"==/a/[-1]&&e.addEventListener("DOMMouseScroll",C,!1),-[1]&&e.setAttribute("_zoomsize",e.offsetWidth+","+e.offsetHeight)};var k=function(e,t){t=t||document.body;var a=e.offsetLeft,n=e.offsetTop;for(p=e.offsetParent;p!=t&&p!=document.body;)window.navigator.userAgent.indexOf("MSIE 8.0")>-1?(a+=p.offsetLeft,n+=p.offsetTop):(a+=p.offsetLeft+p.clientLeft,n+=p.offsetTop+p.clientTop),p=p.offsetParent;var r={};return r.x=a,r.y=n,console.log(r),r},E=function(e,t){var a=document.getElementById(t);if(document.getElementById(t).value=document.getElementById(t).value.substr(0,1),document.all&&a.createTextRange&&a.caretPos){var n=a.caretPos;n.text=""==n.text.charAt(n.text.length-1)?e+"":e}else if(a.setSelectionRange){var r=a.selectionStart,o=a.selectionEnd,i=a.value.substring(0,r),l=a.value.substring(o);a.value=i+e+l,a.focus();var s=e.length;a.setSelectionRange(r+s,r+s),a.blur()}else a.value+=e},j=function(e){var t=/[\u4E00-\u9FA5]/g;return t.test(e)?e.match(t).length:0},S=function(){document.getElementById("off_tip").style.display="none"},L=function(){document.getElementById("guide").style.display="none"},N=function(e){for(var t=e+"=",a=document.cookie.split(";"),n=0;n<a.length;n++){for(var r=a[n];" "==r.charAt(0);)r=r.substring(1);if(r.indexOf(t)!=-1)return r.substring(t.length,r.length)}return""},G=function(e){var t="[A-Z0-9a-z._%+-:]+[A-Za-z0-9.-]+\\.[A-Za-z0-9_%+-/#:?&=]{2,61}",a=new RegExp(t,"g");if(e.match(a)){for(var n=e.match(a),r=n.length,o=0;o<r;o++)n[o].indexOf("http")==-1?n[o]='<a style="color:blue;text-decoration:underline;font-size:14px" target="_blank" href="http://'+n[o]+'">'+n[o]+"</a>":n[o]='<a style="color:blue;text-decoration:underline;font-size:14px" target="_blank" href="'+n[o]+'">'+n[o]+"</a>";n[r]="";for(var i=e.split(a),l="",s=0;s<i.length;s++)l+=i[s]+n[s];return l}return!1};return{sendUIMessage:n,changeChatList:t,loadContact:i,getChatMember:o,getChatLog:r,changeNewChatList:a,msgCallBack:s,sendKeydown:m,toOnline:c,toOffline:g,dealExpression:h,touchScroll:b,bottomClick:I,searchFriends:l,myBrowser:x,dealChar:w,FilterPasteText:A,zooming:C,insertAtHtml:E,getPosition:k,getAtPosition:y,insertInput:T,atKeyup:d,cal:j,dealInput:B,insertBlank:M,dealInputValue:v,dealSendInput:f,atSomebody:u,isShowTip:S,closeGuide:L,setCookie:e,getCookie:N,CheckUrl:G}}(),BBWeb=function(){function newQeqArray(){for(var e=new Array,t=0;t<circleRoomMap.size();t++){var a={},n=circleRoomMap.data[circleRoomMap.keys[t]],r=n.jid;BBGlobal.array.push(r),a.jid=n.jid;for(var o=new Array,i=n.member,l=0;l<i.length&&5!=l;l++){var s=i[l].jid;o[o.length]=circleMap.data[s].avatar}a.member=o,e[e.length]=JSON.stringify(a)}return e}function reqCircleAvatar(){if(0==BBGlobal.refreshCount)var e=newQeqArray();if(BBGlobal.refreshCount>=1&&BBGlobal.refreshCount<3)if(0==BBGlobal.array.length)var e=newQeqArray();else for(var e=new Array,t=0;t<BBGlobal.array.length;t++){var a={},n=BBGlobal.array[t],r=circleRoomMap.get(n);a.jid=r.jid;for(var o=new Array,i=r.member,l=0;l<i.length;l++){var s=i[l].jid;o[o.length]=circleMap.data[s].avatar}a.member=o,e[e.length]=JSON.stringify(a)}if(!(BBGlobal.refreshCount>=3)){var c={},n="",g="";c.param=e;var m=e.length;$.ajax({url:BBWeb.bashPath()+"/headPortrait",datatype:"json",type:"post",data:{datas:e},success:function(e,t){if(0==e.list.length&&0==BBGlobal.refreshCount)BBGlobal.refreshCount++,BBGlobal.array=[],reqCircleAvatar();else{for(var a=0;a<e.list.length;a++)try{n=e.list[a].jid,BBGlobal.array.remove(n),g=e.list[a].key;var r=circleRoomMap.get(n);r.avatar=BBGlobal.TFS_URL+g,r.avatar100=BBGlobal.TFS_URL+g,r.avatar200=BBGlobal.TFS_URL+g}catch(e){console.warn("circleRoomMap："+n);continue}for(var o=0;o<windowsArray.length;o++)try{var i=chatMap.get(windowsArray[o]);if("groupchat"==i.type){var l=i.jid,r=circleRoomMap.get(l);i.avatar=r.avatar}}catch(e){console.warn("chatMap："+l);continue}var s=document.body,c=angular.element(s).scope();c.$apply(),m!=e.list.length&&(BBGlobal.refreshCount++,reqCircleAvatar())}},error:function(e,t,a){BBGlobal.refreshCount<3&&(BBGlobal.refreshCount++,BBGlobal.array=[],reqCircleAvatar())}})}}var bashPath=function(){return window.location.protocol+"//"+window.location.host},goScan=function(){$("#qrdiv").show(),$("#qrokdiv").hide()},showMainChat=function(){$("#loginDiv").hide(),$("#mainchat").show()},onConnect=function(e){console.log(e),e==Strophe.Status.CONNFAIL?$("#loginStatus").text("连接失败"):e==Strophe.Status.AUTHFAIL?$("#loginStatus").text("登录失败"):e==Strophe.Status.DISCONNECTED?(BBUI.toOffline(),connected=!1,document.getElementById("off_tip").style.display="block"):e==Strophe.Status.CONNECTED&&($("#loginStatus").text("连接成功"),BBUI.toOnline(),connection.rawInput=function(e){console.log("RECV: "+e)},connection.rawOutput=function(e){console.log("SEND: "+e)},connected=!0,showMainChat(),document.getElementById("off_tip").style.display="none",BBWeb.initChatList(BBGlobal.jsonArray),setInterval("BBWeb.checkAckMap()",2e4),connection.addHandler(onMessage,null,"message",null,null,null),connection.addHandler(onRosterIQ,"jabber:iq:roster","iq",null,null,null),connection.addHandler(onCircleListIQ,"http://www.nihualao.com/xmpp/circle/list","iq",null,null,null),connection.addHandler(onUserinfoIQ,"http://www.nihualao.com/xmpp/userinfo","iq",null,null,null),connection.addHandler(onCircleNotifyIQ,"http://www.nihualao.com/xmpp/circle/notify","iq",null,null,null),connection.send($pres().tree()),LoadContactByIQ(),LoadCircleByIQ(),iqLoadCircle(),iqLoadContact())},setCircleRoomInfo=function(e,t,a){var n={};n.jid=t,n.type="groupchat";var r=circleRoomMap.get(t);void 0!=r?(n.avatar=r.avatar,n.avatar100=r.avatar100,n.avatar200=r.avatar200):(n.avatar="imgs/grouphead40.jpg",n.avatar100="imgs/grouphead100.jpg",n.avatar200="imgs/grouphead100.jpg"),n.roomContact=!0,n.name=e.getAttribute("name"),n.creator=e.getAttribute("creator"),n.circletype=e.getAttribute("circletype"),n.ver=e.getAttribute("ver"),n.createdate=e.getAttribute("createdate"),n.modificationdate=e.getAttribute("modificationdate"),n.room=e.getAttribute("jid"),n.inviteurl=e.getAttribute("inviteurl"),n.status=e.getAttribute("status");for(var o=e.getElementsByTagName("members")[0].getElementsByTagName("member"),i=new Array,l="",s=0;s<o.length;s++){var c=o[s],g=c.getAttribute("jid"),m={};m.jid=g,m.nickname=c.getAttribute("nickname"),m.role=c.getAttribute("role"),m.create=c.getAttribute("create"),i[i.length]=m;var u=circleMap.get(g);if(void 0==u||a.join("").indexOf(u.jid)<0&&""==u.ver){var d={};d.jid=g,d.ver="",circleMap.put(g,d),a[a.length]=g}s<3&&(l=0==s?m.nickname:m.nickname+"、"+l)}return""!=n.name&&null!=n.name||(n.name=l),n.name_sort=pinyin.getFullChars(n.name).toUpperCase(),n.name_first_sort=pinyin.getCamelChars(n.name).toUpperCase(),n.member=i,circleRoomMap.put(t,n),a},onCircleNotifyIQ=function(e){console.log(e);try{for(var t=e.getElementsByTagName("query")[0].getElementsByTagName("circle"),a=0;a<t.length;a++){var n=t[a],r=n.getAttribute("room"),o=n.getAttribute("ver"),i=n.getAttribute("remove"),l=new Array,s=circleRoomMap.get(r);if(void 0==s)l=setCircleRoomInfo(n,r,l),l.length>0?(BBGlobal.array[BBGlobal.array.length]=r,iqUserInfo(l)):BBGlobal.initDataFlag&&(BBGlobal.refreshCount=1,BBGlobal.array[BBGlobal.array.length]=r,reqCircleAvatar()),BBUI.loadContact();else if(i){var c=document.body,g=angular.element(c).scope();g.removeGroup(r),g.$apply()}else{s.ver=o;var m=n.getElementsByTagName("members")[0];if(void 0==m){var u=n.getElementsByTagName("member")[0];if(void 0!=u)for(var d=u.getAttribute("jid"),a=0;a<s.member.length;a++){var p=s.member[a];if(d==p.jid)return p.nickname=u.getAttribute("nickname"),!0}var y=n.getAttribute("name");return null!=y&&void 0!=y&&""!=y&&(s.name=y,s.name_sort=pinyin.getFullChars(y).toUpperCase(),s.name_first_sort=pinyin.getCamelChars(y).toUpperCase()),!0}for(var h=m.getElementsByTagName("member"),B=(new Array,0);B<h.length;B++){var u=h[B],d=u.getAttribute("jid"),f=u.getAttribute("remove"),v=BBGlobal.jid.substring(0,BBGlobal.jid.length-4);if("true"==f)for(var a=0;a<s.member.length;a++){var p=s.member[a];if(d==p.jid&&s.member.remove(p),d==v){var c=document.body,g=angular.element(c).scope();g.removeGroup(r),g.$apply()}}else{var b={};b.jid=d,b.nickname=u.getAttribute("nickname"),b.role=u.getAttribute("role"),b.create=u.getAttribute("create");for(var I=s.member,T=0,M=0;M<I.length;M++)if(I[M].jid==d){T=1;break}0==T&&I.push(b);var x=circleMap.get(d);if(void 0==x||l.join("").indexOf(x.jid)<0&&""==x.ver){var w={};w.jid=d,w.ver="",circleMap.put(d,w),l[l.length]=d}}}l.length>0&&iqUserInfo(l)}}}catch(e){return console.error(e),!0}return!0},onCircleListIQ=function(e){return!0},onUserinfoIQ=function(e){console.log("onUserinfoIQ:"+e);try{var t=e.getElementsByTagName("query")[0].getElementsByTagName("user");t.length>1&&(BBGlobal.userDateFlag=!0);for(var a=0;a<t.length;a++){var n=t[a],r=n.getAttribute("jid"),o=circleMap.get(r);if(void 0==o&&(o={},circleMap.put(r,o)),setUserInfo(o,n,r),!BBGlobal.userLoading&&r.split("@")[0]==BBGlobal.userLoadingjid.split("@")[0]){BBGlobal.userLoading=!0;var i=document.body,l=angular.element(i).scope();l.refreshProfile(o)}}for(var s=0;s<t.length;s++){var n=t[s],r=n.getAttribute("jid"),o=contactMap.get(r);void 0!=o&&setUserInfo(o,n,r)}if(BBUI.loadContact(),SynchronizeChat(),BBGlobal.initDataFlag)BBGlobal.array.length>0&&(BBGlobal.refreshCount=1,reqCircleAvatar());else if(BBGlobal.contactDataFlag&&BBGlobal.circleDataFlag){BBGlobal.initDataFlag=!0,reqCircleAvatar();var i=document.body,l=angular.element(i).scope();l.isLoading=BBGlobal.initDataFlag,l.$apply(),chatlistFinish()}return!0}catch(e){return console.error(e),!0}},SynchronizeChat=function(){for(var e=0;e<chatMap.size();e++)try{var t=chatMap.keys[e],a=chatMap.get(t);if("groupchat"==a.type){var n=circleRoomMap.get(t);void 0!=n&&(a.name=n.name,a.avatar=n.avatar)}else if("chat"==a.type){var r=contactMap.get(t);if(void 0!=r)a.name=r.displayName,a.avatar=r.avatar,a.accountType=r.accountType;else{var o=circleMap.get(t);void 0!=o&&(a.name=o.displayName,a.avatar=o.avatar,a.accountType=o.accountType)}}}catch(e){console.error(e);continue}BBUI.changeChatList()},checkUserData=function(){for(var e=0;e<contactMap.keys.length;e++){var t=contactMap.get(contactMap.keys[e]).ver;if(""==t||void 0==t)return!1}return!0},setUserInfo=function(e,t,a){try{return e.type="chat",e.roomContact=!1,e.jid=a,e.ver=t.getAttribute("ver"),e.phone=Strophe.getText(t.getElementsByTagName("phone")[0]),e.name=Strophe.getText(t.getElementsByTagName("name")[0]),e.employeeNme=Strophe.getText(t.getElementsByTagName("employeeNme")[0]),null!=e.employeeNme&&""!=e.employeeNme?e.displayName=e.employeeNme:e.displayName=e.name,e.name_sort=pinyin.getFullChars(e.displayName).toUpperCase(),e.name_first_sort=pinyin.getCamelChars(e.name).toUpperCase(),null!=Strophe.getText(t.getElementsByTagName("avatar")[0])&&""!=Strophe.getText(t.getElementsByTagName("avatar")[0])?(e.avatar=BBGlobal.TFS_URL+Strophe.getText(t.getElementsByTagName("avatar")[0]),e.avatar100=e.avatar,e.avatar200=e.avatar):(e.avatar="imgs/nohead.gif",e.avatar100="imgs/nohead100.gif",e.avatar200="imgs/nohead200.gif"),e.activated=Strophe.getText(t.getElementsByTagName("activated")[0]),e.passwordReplaced=Strophe.getText(t.getElementsByTagName("passwordReplaced")[0]),e.email=Strophe.getText(t.getElementsByTagName("email")[0]),e.secondEmail=Strophe.getText(t.getElementsByTagName("secondEmail")[0]),e.source=Strophe.getText(t.getElementsByTagName("source")[0]),e.inviteUrl=Strophe.getText(t.getElementsByTagName("inviteUrl")[0]),e.accountType=Strophe.getText(t.getElementsByTagName("accountType")[0]),e.cemployeeCde=Strophe.getText(t.getElementsByTagName("cemployeeCde")[0]),e.accountName=Strophe.getText(t.getElementsByTagName("accountName")[0]),e.gender=Strophe.getText(t.getElementsByTagName("gender")[0]),e.areaId=Strophe.getText(t.getElementsByTagName("areaId")[0]),e.signature=Strophe.getText(t.getElementsByTagName("signature")[0]),e.bookNme=Strophe.getText(t.getElementsByTagName("bookNme")[0]),e.agencyNme=Strophe.getText(t.getElementsByTagName("agencyNme")[0]),e.branchNme=Strophe.getText(t.getElementsByTagName("branchNme")[0]),e.centerNme=Strophe.getText(t.getElementsByTagName("centerNme")[0]),e.departmentNme=Strophe.getText(t.getElementsByTagName("departmentNme")[0]),e.employeePhone=Strophe.getText(t.getElementsByTagName("employeePhone")[0]),e.publicPhone=Strophe.getText(t.getElementsByTagName("publicPhone")[0]),e.officalPhone=Strophe.getText(t.getElementsByTagName("officalPhone")[0]),!0}catch(e){return console.error(e),!0}},onRosterIQ=function(e){return!0},onMessage=function(e){console.log(e);try{var t=e.getAttribute("from"),a=e.getAttribute("to"),n=t.split("/")[0],r=a.split("/")[0],o=!1;if(n.indexOf("public-number")>0||r.indexOf("public-number")>0)return!0;var i,l,s=BBGlobal.jid.split("/")[0],c=e.getAttribute("id"),g=(e.getAttribute("messageId"),e.getAttribute("type")),m=e.getElementsByTagName("body"),u=e.getElementsByTagName("delay")[0].getAttribute("stamp");u=formatMsgTime(u);var d,p,y=parseInt(u.replace(":",""),10),h=!1,B=!1,f={},v={};if("chat"==g&&m.length>0){p=Strophe.getText(e.getElementsByTagName("subject")[0]),(BBGlobal.tojid==n||n==s&&r==BBGlobal.tojid)&&(B=!0);var b;n==s?(v=getUserInfoByJid(r),b=getLastMessageTime(r),h=!0,i=BBGlobal.loginAvatar):(v=getUserInfoByJid(n),b=getLastMessageTime(n),i=v.avatar);var I=circleMap.get(n);if(f.accountType=I.accountType,"chat"==p){var T=m[0];d=Strophe.getText(T);var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M&&(d=transferForExpression(d)),f.uuid=c,f.jid=n,f.avatar=i;var x=d;BBUI.CheckUrl(x)&&x.indexOf("<img")==-1?(x=BBUI.CheckUrl(x),f.message=getStringForExpression(x)):f.message=getStringForExpression(d),f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("image"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[Picture]":null!=M&&"邦邦社区"==M&&(d="[图片]"),f.uuid=c,f.jid=n,f.avatar=i,f.message=A.data,f.link=BBGlobal.TFS_URL+A.link+"?name="+c+".jpg",f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("document"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),C=A.fileName,k=A.size,E=A.fileType,j=BBGlobal.TFS_URL+A.link,M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[File]"+C:null!=M&&"邦邦社区"==M&&(d="[文件]"+C),f.uuid=c,f.jid=n,f.message=C,f.fileType=E,f.size=k,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime="",f.avatar=i;var S=encodeURI(C);f.link=j+"?name="+S}else if("voice"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),L=A.time,N=BBGlobal.TFS_URL+A.link,M=(A.link,document.getElementById("logo").innerHTML);null!=M&&"BangBang Community"==M?d="[Voice]":null!=M&&"邦邦社区"==M&&(d="[语音]"),f.uuid=c,f.jid=n,f.avatar=i,f.message=N,f.mp3url="",f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime="",f.voiceSize=L,f.read=!1,f.play=!1}else if("location"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[Geographical Position]":null!=M&&"邦邦社区"==M&&(d="[地理位置]"),f.uuid=c,f.jid=n,f.avatar=i,f.locationName=A.locationName,f.address=A.address,f.longitude=A.longitude,f.latitude=A.latitude,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("article"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w);f.uuid=c,f.jid=n,f.avatar=i,f.title=A.title;var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[Link]"+f.title:null!=M&&"邦邦社区"==M&&(d="[链接]"+f.title),f.src=A.src,f.abstract=A.abstract,f.coverL=BBGlobal.TFS_URL+A.coverL,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else{if("card"!=p&&"redpacket"!=p)return!0;var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[You receive a message, please view the phone]":null!=M&&"邦邦社区"==M&&(d="[您有一条消息，请在手机端查看]"),f.uuid=c,f.jid=n,f.avatar=i,f.message=d,f.subject="chat",f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}}else{if(!("groupchat"==g&&m.length>0))return!0;p=Strophe.getText(e.getElementsByTagName("mtype")[0]);var G=t.split("/")[1].split("_")[0]+"@ab-insurance.com";if(s==n)return!0;if(G==BBGlobal.jid.split("/")[0]){h=!0;var F=chatLogMap.get(n);if(void 0!=F)for(var U=0;U<F.data.length;U++)if(F.data[U].uuid==c)return!0}BBGlobal.tojid==n&&(B=!0),v=getCircleRoomByJid(n);var b=getLastMessageTime(n);if(h)i=BBGlobal.loginAvatar,l=BBGlobal.loginName;else{var R=getUserInfoByJid(G);i=R.avatar,l=R.name}var I=circleMap.get(G);if(void 0!=I&&(f.accountType=I.accountType),"notice"==p){var T=m[0];d=Strophe.getText(T),f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.message=getStringForExpression(d),f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("chat"==p){var T=m[0];d=Strophe.getText(T);var _=d,D=e.getElementsByTagName("jid");if(void 0!=D&&D.length>0){f.isAt=!1;for(var O=0;O<D.length;O++){var H=Strophe.getText(D[O]);if(H==s){o=!0;break}}}var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M&&(d=transferForExpression(d)),f.uuid=c,f.jid=G,f.name=l,f.avatar=i;var x=d;BBUI.CheckUrl(x)&&x.indexOf("<img")==-1?(x=BBUI.CheckUrl(x),f.message=getStringForExpression(x)):f.message=getStringForExpression(_),d=l+"："+d,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("voice"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),L=A.time,N=BBGlobal.TFS_URL+A.link,M=(A.link,document.getElementById("logo").innerHTML);null!=M&&"BangBang Community"==M?d=l+"：[Voice]":null!=M&&"邦邦社区"==M&&(d=l+"：[语音]"),f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.message=N,f.mp3url="",f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime="",f.voiceSize=L,f.read=!1,f.play=!1}else if("image"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d=l+"：[Picture]":null!=M&&"邦邦社区"==M&&(d=l+"：[图片]"),f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.message=A.data,f.link=BBGlobal.TFS_URL+A.link+"?name="+c+".jpg",f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else if("document"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),C=A.fileName,k=A.size,E=A.fileType,j=BBGlobal.TFS_URL+A.link,M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d=l+"：[File]"+C:null!=M&&"邦邦社区"==M&&(d=l+"：[文件]"+C),f.uuid=c,f.jid=G,f.name=l,f.message=C,f.fileType=E,f.size=k,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime="",f.avatar=i;var S=encodeURI(C);f.link=j+"?name="+S}else if("location"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w),M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d=l+"：[Geographical Position]":null!=M&&"邦邦社区"==M&&(d=l+"：[地理位置]"),f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.locationName=A.locationName,f.address=A.address,f.longitude=A.longitude,f.latitude=A.latitude,f.subject=p,f.from_me=h,f.ackflag=1,
y>b?f.msgTime=u:f.msgTime=""}else if("article"==p){var T=m[0],w=T.textContent,A=jQuery.parseJSON(w);f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.title=A.title;var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d=l+"：[Link]"+f.title:null!=M&&"邦邦社区"==M&&(d=l+"：[链接]"+f.title),f.src=A.src,f.abstract=A.abstract,f.coverL=BBGlobal.TFS_URL+A.coverL,f.subject=p,f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}else{if("card"!=p&&"redpacket"!=p)return!0;var M=document.getElementById("logo").innerHTML;null!=M&&"BangBang Community"==M?d="[You receive a message, please view the phone]":null!=M&&"邦邦社区"==M&&(d="[您有一条消息，请在手机端查看]"),f.uuid=c,f.jid=G,f.name=l,f.avatar=i,f.message=d,d=l+"："+d,f.subject="chat",f.from_me=h,f.ackflag=1,y>b?f.msgTime=u:f.msgTime=""}}if(!checkMessageId(c))return!0;BBWeb.changeWinArr(v.jid),null!=v.employeeNme?BBWeb.updatechatMap(v.jid,v.employeeNme,v.avatar,B,d,u,p,v.type,o,v.accountType):BBWeb.updatechatMap(v.jid,v.name,v.avatar,B,d,u,p,v.type,o,v.accountType),BBWeb.addChatLogMap(v.jid,f),BBUI.changeChatList(),B&&BBUI.sendUIMessage(n,f),"chat"==v.type?BBGlobal.chatNotice&&!B&&DesktopNotifications(v,d):BBGlobal.groupChatNotice&&!B&&DesktopNotifications(v,d)}catch(e){return console.error(e),!0}return!0},getStringForExpression=function(message){var re1="(\\[.*?\\])";re1=new RegExp(re1,["g"]);var expressionArray=message.match(re1);if(null==expressionArray)return message;expressionArray.sort();for(var re=[this[0]],i=1;i<expressionArray.length+1;i++)if(expressionArray[i-1]!==re[re.length-1]){re.push(expressionArray[i-1]);var html=BBExpression.getExHtml(expressionArray[i-1]);if(""==html)continue;var faceName=eval("/\\["+expressionArray[i-1].split("[")[1].split("]")[0]+"\\]/g");message=message.replace(faceName,html)}return message},transferForExpression=function(message){var re1="(\\[.*?\\])";re1=new RegExp(re1,["g"]);var expressionArray=message.match(re1);if(null==expressionArray)return message;expressionArray.sort();for(var re=[this[0]],i=1;i<expressionArray.length+1;i++)if(expressionArray[i-1]!==re[re.length-1]){re.push(expressionArray[i-1]);var eng=BBExpression.getExEng(expressionArray[i-1]);if(""==eng)continue;var faceName=eval("/\\["+expressionArray[i-1].split("[")[1].split("]")[0]+"\\]/g");message=message.replace(faceName,eng)}return message},DesktopNotifications=function(e,t){if(window.Notification)if("granted"===Notification.Permission);else{Notification.requestPermission();var a=new Notification(e.name+":",{dir:"auto",lang:"zh-CN",body:t,icon:e.avatar,tag:e.jid});a.onshow=function(){setTimeout(function(){a.close()},5e3)},a.onclick=function(){window.focus();var e=chatMap.get(a.tag);console.log(e);var t=document.body,n=angular.element(t).scope();n.chatItemClick(e),n.$apply(),a.close()}}},getLastMessageTime=function(e){var t=chatLogMap.get(e),a="";if(void 0!=t)for(var n=t.data.length-1;n>=0;n--){var a=t.data[n].msgTime;if(""!=a)return parseInt(a.replace(":",""),10)}return 0},resendText=function(e){if(connected)connection.send(e.msg);else{var t=document.body,a=angular.element(t).scope(),n=document.getElementById("logo").innerHTML;null!=n&&"BangBang Community"==n?a.pointDesc="Please login first！":null!=n&&"邦邦社区"==n&&(a.pointDesc="请先登录！"),a.$apply(),document.getElementById("point").style.display="block"}},sendText=function(){BBUI.dealSendInput(document.getElementById("editArea").innerHTML),document.getElementById("editArea").innerHTML=document.getElementById("editArea").innerHTML.replace(/(^\s*)|(\s*$)/g,""),BBUI.FilterPasteText(document.getElementById("editArea").innerHTML);var e=document.getElementById("editArea").innerHTML,t=e;if(BBUI.CheckUrl(e)&&e.indexOf("<img")==-1&&(e=BBUI.CheckUrl(e)),""!=$.trim(e)&&""!=document.getElementById("editArea").innerHTML&&"<br>"!=document.getElementById("editArea").innerHTML){var a=document.getElementById("titleId").value;document.getElementById("titleName").value;console.log(document.getElementById("editArea").innerHTML);var n=document.getElementById("titleType").value,r={};if(connected){var o=Math.uuid(),i=getLastMessageTime(a),l=getTime(),s=parseInt(l.replace(":",""),10),c={};c.uuid=o,c.jid=BBGlobal.jid,c.message=e,c.subject="chat",c.from_me=!0,c.ackflag=0,s>i?c.msgTime=l:c.msgTime="",c.avatar=BBGlobal.loginAvatar,BBUI.sendUIMessage(a,c),document.getElementById("editArea").innerHTML="";var g=BBUI.dealExpression(t),m=g,u=document.getElementById("logo").innerHTML;if(null!=u&&"BangBang Community"==u&&(g=transferForExpression(g)),m=BBUI.dealChar(m),"groupchat"==n){r=getCircleRoomByJid(a),BBWeb.changeWinArr(r.jid),BBWeb.updatechatMap(r.jid,r.name,r.avatar,!0,g,l,"chat",r.type,"",r.accountType),BBWeb.addChatLogMap(r.jid,c),BBUI.changeChatList();var d=$msg({to:a,from:BBGlobal.jid,type:"groupchat",id:o}).c("body").t(m).up();if(atMembersMap.size()>0){d=d.c("at");for(var p=0;p<atMembersMap.size();p++){var y=atMembersMap.data[atMembersMap.keys[p]];g.indexOf(atMembersMap.keys[p])>-1&&(d=d.c("jid").t(y).up())}d=d.up(),atMembersMap=new Map,inputsMap=new Map}d=d.c("req",{xmlns:"urn:xmpp:receipts",id:o}).up().c("mtype",{xmlns:"message:type"}).t("chat"),console.log(d.tree()),c.msg=d.tree(),connection.send(d.tree())}else if("chat"==n){r=getUserInfoByJid(a),console.log(r),BBWeb.changeWinArr(r.jid),null!=r.employeeNme?BBWeb.updatechatMap(r.jid,r.employeeNme,r.avatar,!0,g,l,"chat",n,"",r.accountType):BBWeb.updatechatMap(r.jid,r.name,r.avatar,!0,g,l,"chat",n,"",r.accountType),BBWeb.addChatLogMap(r.jid,c),BBUI.changeChatList();var d=$msg({to:a,from:BBGlobal.jid,type:"chat",id:o}).c("body").t(m).up().c("subject").t("chat");c.msg=d.tree(),connection.send(d.tree())}}else{var h=document.body,B=angular.element(h).scope(),u=document.getElementById("logo").innerHTML;null!=u&&"BangBang Community"==u?B.pointDesc="Please login first！":null!=u&&"邦邦社区"==u&&(B.pointDesc="请先登录！"),B.$apply(),document.getElementById("point").style.display="block"}}},sendFiles=function(e){$.ajaxFileUpload({url:BBWeb.bashPath()+"/imageUpload",type:"post",secureuri:!1,fileElementId:"hiddenFile",dataType:"json",success:function(e,t){alert("sendImage---success!!")},error:function(e,t,a){alert("图片上传失败，请重试！！")}})},sendFile=function(e){var t=(document.getElementById("hiddenFile").value,e.name),a=e.size,n=e.type;if(n.indexOf("image")>-1)sendImage(e);else{var r=t.substr(t.lastIndexOf(".")).toLowerCase();r=r.substring(1,r.length);for(var o=["doc","ppt","xls","pdf","docx","xlsx","pptx"],i=!1,l=0;l<o.length;l++)if(o[l]==r){i=!0;break}if(i)sendDocument(e,t,a,r);else{var s=document.body,c=angular.element(s).scope(),g=document.getElementById("logo").innerHTML;null!=g&&"BangBang Community"==g?c.pointDesc="Do not accept this file type!":null!=g&&"邦邦社区"==g&&(c.pointDesc="不接受此文件类型！"),c.$apply(),document.getElementById("point").style.display="block"}}},sendImage=function(e){var t=document.body,a=angular.element(t).scope(),n=document.getElementById("logo").innerHTML;if(""==$("#input-contacts").val())return null!=n&&"BangBang Community"==n?a.pointDesc="Please enter a contact!":null!=n&&"邦邦社区"==n&&(a.pointDesc="请输入联系人！"),a.$apply(),void(document.getElementById("point").style.display="block");var r,o=document.getElementById("titleId").value,i=(document.getElementById("titleName").value,document.getElementById("titleType").value),n=document.getElementById("logo").innerHTML;null!=n&&"BangBang Community"==n?r="[Picture]":null!=n&&"邦邦社区"==n&&(r="[图片]");var l={},s=window.URL||window.webkitURL,c=s.createObjectURL(e),g=Math.uuid(),m=getLastMessageTime(o),u=getTime(),d=parseInt(u.replace(":",""),10),p={};p.uuid=g,p.jid=BBGlobal.jid,p.subject="image",p.from_me=!0,p.ackflag=0,p.fileUrl=c,d>m?p.msgTime=u:p.msgTime="",p.avatar=BBGlobal.loginAvatar,BBUI.sendUIMessage(o,p),"groupchat"==i?l=getCircleRoomByJid(o):"chat"==i&&(l=getUserInfoByJid(o)),BBWeb.changeWinArr(l.jid),BBWeb.updatechatMap(l.jid,l.name,l.avatar,!0,r,u,"image",l.type,"",l.accountType),BBWeb.addChatLogMap(l.jid,p),BBUI.changeChatList(),$.ajaxFileUpload({url:BBWeb.bashPath()+"/imageUpload",type:"post",secureuri:!1,fileElementId:"hiddenFile",dataType:"json",success:function(e,t){if(console.log("sendImage---success!!"),"1"==e.serverCode)if(connected){if(p.message=e.imgBase64,p.link=BBGlobal.TFS_URL+e.key+"?name="+p.uuid+".jpg","groupchat"==i){var r=e.imgBase64.replace(/[\r\n]/g,""),l=$msg({to:o,from:BBGlobal.jid,type:"groupchat",id:g}).c("body").t('{"data":"'+r+'","src":"bea62218-b6e3-47f4-9f2e","link":"'+e.key+'"}').up().c("req",{xmlns:"urn:xmpp:receipts",id:g}).up().c("mtype",{xmlns:"message:type"}).t("image");connection.send(l.tree())}else if("chat"==i){var r=e.imgBase64.replace(/[\r\n]/g,""),l=$msg({to:o,from:BBGlobal.jid,type:"chat",id:g}).c("subject").t("image").up().c("req",{xmlns:"urn:xmpp:receipts",id:g}).up().c("body").t('{"data":"'+r+'","src":"bea62218-b6e3-47f4-9f2e","link":"'+e.key+'"}').up();connection.send(l.tree())}}else p.ackflag=2,BBGlobal.tojid==o&&BBUI.msgCallBack(o,g,2),null!=n&&"BangBang Community"==n?a.pointDesc="Please login first !":null!=n&&"邦邦社区"==n&&(a.pointDesc="请先登录！"),a.$apply(),document.getElementById("point").style.display="block";else p.ackflag=2,BBGlobal.tojid==o&&BBUI.msgCallBack(o,g,2),null!=n&&"BangBang Community"==n?a.pointDesc="Picture upload failed, please try again!":null!=n&&"邦邦社区"==n&&(a.pointDesc="图片上传失败，请重试！"),a.$apply(),document.getElementById("point").style.display="block"},error:function(e,t,n){p.ackflag=2,BBGlobal.tojid==o&&BBUI.msgCallBack(o,g,2);var r=document.getElementById("logo").innerHTML;null!=r&&"BangBang Community"==r?a.pointDesc="Picture upload failed, please try again!":null!=r&&"邦邦社区"==r&&(a.pointDesc="图片上传失败，请重试！"),a.$apply(),document.getElementById("point").style.display="block"}})},sendDocument=function(e,t,a,n){var r=document.body,o=angular.element(r).scope(),i=document.getElementById("logo").innerHTML;if(""==$("#input-contacts").val())return null!=i&&"BangBang Community"==i?o.pointDesc="Please enter a contact!":null!=i&&"邦邦社区"==i&&(o.pointDesc="请输入联系人！"),o.$apply(),void(document.getElementById("point").style.display="block");var l,s=document.getElementById("titleId").value,c=(document.getElementById("titleName").value,document.getElementById("titleType").value),i=document.getElementById("logo").innerHTML;null!=i&&"BangBang Community"==i?l="[File]"+t:null!=i&&"邦邦社区"==i&&(l="[文件]"+t);var g={},m=window.URL||window.webkitURL,u=m.createObjectURL(e),d=Math.uuid(),p=getLastMessageTime(s),y=getTime(),h=parseInt(y.replace(":",""),10),B={};B.uuid=d,B.jid=BBGlobal.jid,B.message=t,B.fileType=n,B.size=getFileSize(a),B.subject="document",B.from_me=!0,B.ackflag=0,B.fileUrl=u,h>p?B.msgTime=y:B.msgTime="",B.avatar=BBGlobal.loginAvatar,BBUI.sendUIMessage(s,B),"groupchat"==c?g=getCircleRoomByJid(s):"chat"==c&&(g=getUserInfoByJid(s));var f=encodeURI(B.message);BBWeb.changeWinArr(g.jid),BBWeb.updatechatMap(g.jid,g.name,g.avatar,!0,l,y,"document",g.type,"",g.accountType),BBWeb.addChatLogMap(g.jid,B),BBUI.changeChatList(),$.ajaxFileUpload({url:BBWeb.bashPath()+"/documentUpload",type:"post",secureuri:!1,fileElementId:"hiddenFile",dataType:"json",success:function(e,r){if("1"==e.serverCode)if(connected){if(B.link=BBGlobal.TFS_URL+e.key+"?name="+f,"groupchat"==c){var l=$msg({to:s,from:BBGlobal.jid,type:"groupchat",id:d}).c("body").t('{"fileName":"'+t+'","charSize":"'+a+'","fileType":"'+n+'","size":"'+getFileSize(a)+'","link":"'+e.key+'"}').up().c("req",{xmlns:"urn:xmpp:receipts",id:d}).up().c("mtype",{xmlns:"message:type"}).t("document");connection.send(l.tree())}else if("chat"==c){var l=$msg({to:s,from:BBGlobal.jid,type:"chat",id:d}).c("subject").t("document").up().c("req",{xmlns:"urn:xmpp:receipts",id:d}).up().c("body").t('{"fileName":"'+t+'","charSize":"'+a+'","fileType":"'+n+'","size":"'+getFileSize(a)+'","link":"'+e.key+'"}').up();connection.send(l.tree())}}else B.ackflag=2,BBGlobal.tojid==s&&BBUI.msgCallBack(s,d,2),null!=i&&"BangBang Community"==i?o.pointDesc="Please login first!":null!=i&&"邦邦社区"==i&&(o.pointDesc="请先登录！"),o.$apply(),document.getElementById("point").style.display="block";else B.ackflag=2,BBGlobal.tojid==s&&BBUI.msgCallBack(s,d,2),null!=i&&"BangBang Community"==i?o.pointDesc="File upload failed, please try again!":null!=i&&"邦邦社区"==i&&(o.pointDesc="文件上传失败，请重试！"),o.$apply(),document.getElementById("point").style.display="block"},error:function(e,t,a){B.ackflag=2,BBGlobal.tojid==s&&BBUI.msgCallBack(s,d,2),null!=i&&"BangBang Community"==i?o.pointDesc="File upload failed, please try again!":null!=i&&"邦邦社区"==i&&(o.pointDesc="文件上传失败，请重试！"),o.$apply(),document.getElementById("point").style.display="block"}})},getFileSize=function(e){var t=e/1024;return t>1024?(t/1024).toFixed(2)+"MB":t.toFixed(2)+"KB"},initChatList=function(e){if(void 0!=e&&e.length>0){for(var t=[],a=[],n=0;n<e.length;n++){var r=e[n],o=r.jid;if(!(o.indexOf("public-number")>0)&&(o.indexOf("@circle.ab-insurance.com")>0&&(o=o.split("@")[0]+"@circle-muc.ab-insurance.com"),void 0==chatMap.get(o))){var i={};i.jid=o,i.type=r.type,i.count=0,i.name="",i.nickName="",i.accountType="",i.isAt=!1;var l=r.type;"chat"==l?(""!=r.avatar&&null!=r.avatar&&void 0!=r.avatar?i.avatar=BBGlobal.TFS_URL+r.avatar:i.avatar="imgs/nohead.gif",t.push(o.split("@")[0])):"groupchat"==l&&(i.avatar="imgs/grouphead40.jpg",a.push(o.split("@")[0])),sessionStorage.setItem(o,JSON.stringify(i)),i.message="",chatMap.put(o,i),windowsArray[windowsArray.length]=o}}reqchatlist(t,a),sessionStorage.setItem("windowsArray",windowsArray),BBGlobal.jsonArray=null}else{var s=sessionStorage.getItem("windowsArray");if(""!=s&&null!=s){windowsArray=s.split(",");for(var c=[],n=0;n<windowsArray.length;n++){var g=windowsArray[n],m=sessionStorage.getItem(g),i=JSON.parse(m);i.count=0,c.push(g),chatMap.put(g,i)}windowsArray=c,BBUI.changeChatList(),BBGlobal.chatlistDataFlag=!0;var u=document.body,d=angular.element(u).scope();d.chatlistLoading=BBGlobal.chatlistDataFlag,d.$apply()}else sessionStorage.setItem("windowsArray",""),chatlistFinish()}},LoadCircleByIQ=function(){var e=Math.uuid(),t=$iq({type:"get",id:e,to:"circle.ab-insurance.com"}).c("query",{xmlns:"http://www.nihualao.com/xmpp/circle/list"});connection.sendIQ(t)},iqLoadCircle=function(){var e={};$.ajax({url:BBWeb.bashPath()+"/thirdparty/v1/circle/list",dataType:"json",type:"post",data:e,beforeSend:function(e){e.setRequestHeader("token",BBGlobal.token),e.setRequestHeader("username",BBGlobal.jid.split("@")[0]),console.log("请求群聊列表")},success:function(e,t){console.log("收到群聊列表"),0==e.code?onhttpciccles(e,"contactlist"):1==e.code?alert("token不正确"):(BBGlobal.circleDataFlag=!0,!BBGlobal.initDataFlag&&BBGlobal.circleDataFlag&&BBGlobal.contactDataFlag&&contactFinish())},error:function(e,t){console.log(e);var a=document.body,n=angular.element(a).scope();n.$apply()}})},onhttpciccles=function(e,t){for(var a=e.circleInfos,n=0;n<a.length;n++){var r=a[n],o=r.room,i=r.jid;if(r.jid=o,r.room=i,1!=r.status);else{for(var l=[],s=0;s<r.member.length;s++)"false"==r.member[s].remove&&l.push(r.member[s]);if(r.member=l,""==r.name||void 0==r.name||null==r.name){var c=10;r.member.length<10&&(c=r.member.length);for(var g=0;g<c;g++)r.name+=r.member[g].nickname+"、";r.name=r.name.substring(0,r.name.length-1),r.namemontage=!0}else r.namemontage=!1;r.name_sort=pinyin.getFullChars(r.name).toUpperCase(),r.name_first_sort=pinyin.getCamelChars(r.name).toUpperCase(),""!==r.avatar&&void 0!==r.avatar?(r.avatar=BBGlobal.TFS_URL+r.avatar,r.avatar100=r.avatar,r.avatar200=r.avatar):(r.avatar="imgs/grouphead40.jpg",r.avatar100="imgs/grouphead100.jpg",r.avatar200="imgs/grouphead100.jpg"),r.type="groupchat",r.roomContact=!0;for(var m=0;m<r.member.length;m++){var u=circleMap.get(r.member[m].jid);""!=u&&void 0!=u||(""!==r.member[m].avatar&&void 0!==r.member[m].avatar?(r.member[m].avatar=BBGlobal.TFS_URL+r.member[m].avatar,r.member[m].avatar100=BBGlobal.TFS_URL+r.member[m].avatar,r.member[m].avatar200=BBGlobal.TFS_URL+r.member[m].avatar):(r.member[m].avatar="imgs/nohead.gif",r.member[m].avatar100="imgs/nohead100.gif",r.member[m].avatar200="imgs/nohead200.gif"),""!=r.member[m].name&&void 0!=r.member[m].name||(r.member[m].name=r.member[m].displayName),r.member[m].type="chat",circleMap.put(r.member[m].jid,r.member[m]))}circleRoomMap.put(o,r)}}"contactlist"==t?(console.log("circlefinish"),BBUI.loadContact(),BBGlobal.circleDataFlag=!0,!BBGlobal.initDataFlag&&BBGlobal.circleDataFlag&&BBGlobal.contactDataFlag&&contactFinish()):(console.log("chatlistcirclefinish"),BBGlobal.chatcircleFlag=!0,!BBGlobal.chatlistDataFlag&&BBGlobal.chatcircleFlag&&BBGlobal.chatcontactFlag&&chatlistFinish())},LoadContactByIQ=function(){var e=Math.uuid(),t=$iq({type:"get",id:e}).c("query",{xmlns:"jabber:iq:roster"});connection.sendIQ(t)},iqLoadContact=function(){var e={version:0};$.ajax({url:BBWeb.bashPath()+"/thirdparty/v1/user/rosterInfo",dataType:"json",type:"post",data:e,beforeSend:function(e){e.setRequestHeader("token",BBGlobal.token),e.setRequestHeader("username",BBGlobal.jid.split("@")[0]),console.log("请求好友列表")},success:function(e,t){if(console.log("收到好友列表"),null!=e){for(var a={},n=0;n<e.roster.length;n++){var r=e.roster[n].jid.split("@")[0],o=e.roster[n].accounttype;a[r]=o;var i=e.roster[n];i.type="chat",i.roomContact=!1,contactMap.put(r+"@ab-insurance.com",i)}iqUserInfoarray(a,"contactlist")}else BBGlobal.contactDataFlag=!0,console.log("contactDatafinish"),!BBGlobal.initDataFlag&&BBGlobal.circleDataFlag&&BBGlobal.contactDataFlag&&contactFinish()},error:function(e,t){console.log(e);var a=document.body,n=angular.element(a).scope();n.$apply()}})},iqUserInfoarray=function(e,t){try{$.ajax({url:BBWeb.bashPath()+"/thirdparty/v1/user/queryUserinfo4Array",dataType:"json",type:"post",data:{jidAndType:JSON.stringify(e)},beforeSend:function(e){e.setRequestHeader("token",BBGlobal.token),e.setRequestHeader("username",BBGlobal.jid.split("@")[0])},success:function(e,a){for(var n=0;n<e.users.length;n++){var r=e.users[n].jid+"@ab-insurance.com",o=e.users[n];o.jid=r,o.type="chat",o.roomContact=!1,null!=o.avatar&&""!=o.avatar?(o.avatar=BBGlobal.TFS_URL+o.avatar,o.avatar100=o.avatar,o.avatar200=o.avatar):(o.avatar="imgs/nohead.gif",o.avatar100="imgs/nohead100.gif",o.avatar200="imgs/nohead200.gif"),o.nickname=o.name,o.remarkName?o.displayName=o.remarkName:o.employeeNme?o.displayName=o.employeeNme:o.displayName=o.name,o.name_sort=pinyin.getFullChars(o.displayName).toUpperCase(),o.name_first_sort=pinyin.getCamelChars(o.displayName).toUpperCase(),"contactlist"==t&&contactMap.put(r,o),circleMap.put(r,o)}"contactlist"==t?(BBGlobal.contactDataFlag=!0,BBUI.loadContact(),console.log("contactDatafinish"),!BBGlobal.initDataFlag&&BBGlobal.circleDataFlag&&BBGlobal.contactDataFlag&&contactFinish()):(console.log("chatlistcontactfinish"),BBGlobal.chatcontactFlag=!0,!BBGlobal.chatlistDataFlag&&BBGlobal.chatcircleFlag&&BBGlobal.chatcontactFlag&&chatlistFinish())},error:function(e,t){console.log(e)}})}catch(e){console.log(e)}},reqchatlist=function(e,t){try{if(e.length>0){for(var a={},n=0;n<e.length;n++){var r=e[n];a[r]=""}iqUserInfoarray(a,"chatlist")}else BBGlobal.chatcontactFlagFlag=!0;if(t.length>0){for(var o={},i=0;i<t.length;i++){var l=t[i];o[l]=0}$.ajax({url:BBWeb.bashPath()+"/thirdparty/v2/circle/list",dataType:"json",type:"post",data:{isFirst:0,isLogin:0,cIdAndVer:JSON.stringify(o)},beforeSend:function(e){e.setRequestHeader("token",BBGlobal.token),e.setRequestHeader("username",BBGlobal.jid.split("@")[0])},success:function(e,t){0==e.code?onhttpciccles(e,"chatlist"):1==e.code&&alert("token不正确")},error:function(e,t){console.log(e)}})}else BBGlobal.chatcircleFlag=!0}catch(e){console.log(e)}},contactFinish=function(){var e=sessionStorage.getItem("windowsArray");if(""!=e&&null!=e){windowsArray=e.split(",");for(var t=[],a=0;a<windowsArray.length;a++){var n=windowsArray[a],r=sessionStorage.getItem(n),o=JSON.parse(r);"chat"!=o.type||contactMap.get(n)?(o.count=0,t.push(n),chatMap.put(n,o)):sessionStorage.removeItem(n)}windowsArray=t,sessionStorage.setItem("windowsArray",t.toString()),BBUI.changeChatList()}SynchronizeChat(),BBGlobal.initDataFlag=!0,BBGlobal.chatlistDataFlag=!0,BBUI.loadContact();var i=document.body,l=angular.element(i).scope();l.isLoading=BBGlobal.initDataFlag,l.chatlistLoading=BBGlobal.chatlistDataFlag,chatlistFinish(),l.$apply()},chatlistFinish=function(){console.log("chatlistFinish");var e=sessionStorage.getItem("windowsArray");if(""!=e&&null!=e){windowsArray=e.split(",");for(var t=[],a=0;a<windowsArray.length;a++){var n=windowsArray[a],r=sessionStorage.getItem(n),o=JSON.parse(r);o="chat"==o.type?circleMap.get(n):circleRoomMap.get(n),o.count=0,t.push(n),chatMap.put(n,o)}windowsArray=t,sessionStorage.setItem("windowsArray",t.toString()),BBUI.changeChatList()}BBGlobal.chatlistDataFlag=!0;var i=document.body,l=angular.element(i).scope();l.chatlistLoading=BBGlobal.chatlistDataFlag,l.$apply()},iqUserInfo=function(e){for(var t=Math.uuid(),a=$iq({type:"get",id:t}).c("query",{xmlns:"http://www.nihualao.com/xmpp/userinfo"}),n=0;n<e.length;n++)a=a.c("user",{jid:e[n]}).up();connection.sendIQ(a.tree())},changeWinArr=function(e){if(windowsArray[0]!=e){for(var t=new Array,a=0;a<windowsArray.length;a++)t[a]=windowsArray[a];windowsArray[0]=e;for(var n=0;n<t.length&&t[n]!=e;n++)windowsArray[n+1]=t[n];sessionStorage.setItem("windowsArray",windowsArray)}},updatechatMap=function(e,t,a,n,r,o,i,l,s,c){var g=chatMap.get(e);"object"==typeof g?(""!=a&&void 0!=a&&(g.avatar=a),""!=t&&void 0!=t&&(g.name=t),""!=c&&void 0!=c&&(g.accountType=c),n?(g.count=0,s=!1,g.isAt=!1):g.count=g.count+1,""!=r&&void 0!=r&&(1==s?(g.message="<span style='color:red'>[有人@我]：</span>"+r,g.isAt=!0):1==g.isAt?g.message="<span style='color:red'>[有人@我]：</span>"+r:g.message=r),""!=i&&void 0!=i&&(g.subject=i),""!=o&&void 0!=o&&(g.msgTime=o)):(g={},g.jid=e,g.avatar=a,g.name=t,g.accountType=c,n?g.count=0:g.count=1,1==s?(g.message="[有人@我]："+r,g.isAt=!0):(g.message=r,g.isAt=!1),g.subject=i,g.type=l,g.msgTime="",chatMap.put(e,g)),unReadCount();var m={};m.jid=g.jid,m.avatar=g.avatar,m.name=g.name,m.accountType=g.accountType,m.type=l,sessionStorage.setItem(e,JSON.stringify(m))},unReadCount=function(){for(var e=0,t=0;t<chatMap.size();t++)e+=chatMap.data[chatMap.keys[t]].count;0==e?document.title="邦邦社区网页版":document.title="(未读"+e+"条）邦邦社区网页版"},formatMsgTime=function(e){var t=parseInt(e.split("T")[1].substr(0,2),10)+8;return t>23?t-=24:t<10&&(t="0"+t),t+":"+e.split("T")[1].substr(3,2)},addChatLogMap=function(e,t){var a=chatLogMap.get(e);if("object"==typeof a){var n=a.data.length;a.data[n]=t}else{var r={};r.data=new Array,r.data[0]=t,chatLogMap.put(e,r)}},getUserInfoByJid=function(e){if(void 0!=contactMap.get(e))return contactMap.get(e);if(void 0!=circleMap.get(e))return circleMap.get(e);var t={};return t.jid=e,t.avatar="imgs/nohead.gif",t.name=e,t.type="chat",t},getCircleRoomByJid=function(e){if(void 0!=circleRoomMap.get(e))return circleRoomMap.get(e);var t={};return t.jid=e,t.avatar="imgs/grouphead40.jpg",t.name=e,t.type="groupchat",t},statusResult=function(){if("null"!=staus&&"logged_in"==staus){var e=document.body,t=angular.element(e).scope(),a=sessionStorage.getItem("content"),n=sessionStorage.getItem("windowsArray"),r=sessionStorage.getItem("loginRealName"),o=sessionStorage.getItem("loginAvatar"),i=sessionStorage.getItem("token");if(BBGlobal.token=i,null==r||""==r)return!1;if($("#loginRealName").text(r),BBGlobal.loginName=r,null==o||""==o)return!1;if(BBGlobal.loginAvatar=o,t.myloginAvatar=BBGlobal.loginAvatar,t.$apply(),null==n)return!1;if(""==n);else{windowsArray=n.split(",");for(var l=0;l<windowsArray.length;l++){var s=windowsArray[l],c=sessionStorage.getItem(s),g=jQuery.parseJSON(c);g.count=0,chatMap.put(s,g)}}if(null==a||""==a)return!1;showMainChat();var m=decryptByDES(a,desKey),u=JSON.parse(m);return BBGlobal.username=u.data.username,BBGlobal.pwd=u.data.pwd,connection=new Strophe.Connection(BBGlobal.BOSH_SERVICE),connection.connect(u.data.username,u.data.pwd,BBWeb.onConnect),BBGlobal.jid=u.data.username,window.location.href="#/index",!0}},addAckMap=function(e,t,a){var n=(new Date).getTime(),r={};r.jid=e,r.uuid=t,r.ack=a,r.date=n,ackMap.put(a,r)},removeAckMap=function(e){try{var t=ackMap.get(e),a=t.jid,n=t.uuid,r=chatLogMap.get(a);console.error("remove:"+n+":"+e);for(var o=r.data.length-1,i=o;i>=0;i--)if(r.data[i].uuid==n){r.data[i].ackflag=1,ackMap.remove(e),tojid==a&&BBUI.msgCallBack(a,n,1);break}}catch(e){return console.error(e),!0}return!0},checkAckMap=function(){for(var e=(new Date).getTime(),t=0;t<ackMap.keys.length;t++){var a=ackMap.keys[t],n=ackMap.get(a),r=n.date,o=n.jid,i=n.uuid;if(!(e-r>2e4))break;for(var l=chatLogMap.get(o),s=l.data.length-1;s>=0;s--)if(l.data[s].uuid==i){l.data[s].ackflag=2,BBGlobal.tojid==o&&BBUI.msgCallBack(o,i,2);break}ackMap.remove(a)}},checkMessageId=function(e){for(var t=0;t<recMsgIdArray.length;t++)if(e==recMsgIdArray[t])return!1;if(recMsgIdArray.length>1e3)for(;recMsgIdArray.length>500;)recMsgIdArray.remove(recMsgIdArray[0]);return recMsgIdArray[recMsgIdArray.length]=e,!0},afterAck=function(e,t,a,n,r,o,i){n="chat"==n?"0":"1";var l=(new Date).getTime(),s={clientType:"web",msgId:e,clientId:t,userId:a,chatType:n,msgType:r,body:o,to:i,sendTime:l.toString()};console.log(s),$.ajax({url:BBWeb.bashPath()+"/httpsendmsg",dataType:"json",type:"post",contentType:"application/x-www-form-urlencoded",data:{json:JSON.stringify(s)},success:function(e,t){console.log(e)},error:function(e,t){console.log(e)}})};return{initChatList:initChatList,statusResult:statusResult,addChatLogMap:addChatLogMap,updatechatMap:updatechatMap,changeWinArr:changeWinArr,unReadCount:unReadCount,sendText:sendText,sendFile:sendFile,sendFiles:sendFiles,bashPath:bashPath,goScan:goScan,showMainChat:showMainChat,onConnect:onConnect,removeAckMap:removeAckMap,checkAckMap:checkAckMap,addAckMap:addAckMap,afterAck:afterAck,iqUserInfo:iqUserInfo}}();Array.prototype.remove=function(e){for(var t=0;t<this.length;t++)e==this[t]&&this.splice(t,1)},function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,a){var n,r=e,o=[];if(a=a||r.length,t)for(n=0;n<t;n++)o[n]=r[0|Math.random()*a];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",n=0;n<36;n++)o[n]||(i=0|16*Math.random(),o[n]=r[19==n?3&i|8:i])}return o=o.join(""),o=o.split("-"),o.join("")},Math.uuidFast=function(){for(var t,a=e,n=new Array(36),r=0,o=0;o<36;o++)8==o||13==o||18==o||23==o?n[o]="-":14==o?n[o]="4":(r<=2&&(r=33554432+16777216*Math.random()|0),t=15&r,r>>=4,n[o]=a[19==o?3&t|8:t]);return n.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,a="x"==e?t:3&t|8;return a.toString(16)})}}();